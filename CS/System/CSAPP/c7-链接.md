# 链接

Linking is the process of collecting and combining various pieces of code and data into a single file that can be _loaded_ into memory and excuted.

Linking can be performed at _compile time_, when the source code is translated into machine code; at _load time_, when the program is loaded into memory and excuted by the _loader_; and even at _run time_, by application programs.

Linkers enable _separate compilation_.

## Compiler Drivers

Most compilation systems provide a _compiler driver that invokes the language preprocessor, compiler, assembler, and linker, as needed on behalf of the user.

First, the driver runs the C preprocessor(cpp), which translate the C source file main.c into an ASCII intermediate file `main.i`.

```bash
cpp [other args] main.c /tmp/main.i
```

Next, the driver runs the C compiler(cc1), which translates `main.i` into an ASCII assembly-language file `main.s`.

```bash
cc1 /tmp/main.i -Og [other args] -o /tmp/main.s
```

Then, the driver runs the assembler(as), which translate `main.s` into a binary _relocatable object file_ `main.o`.

```bash
as [other args] -o /tmp/main.s /tmp/main.s
```

The driver goes througn the same process to generate `sum.o`.

Finally, it runs the linker program ld, which combines `main.o` and `sum.o`, along with the necessary system object files, to create the binary _executable object file_.

```bash
ld -o prg [system obj files and args] /tmp/main.o /tmp/sum.o
```

The shell invokes a function called _loader_, which copies the code and data in the executable file `prog` into memory, and then transfers control to the beginning of the program.

## Static Linking

_Static Linker_ such as the Linux LD program take as input a collection of relocatable object files and command-line arguments and generate as output a fully linked excutable object file.

The input relocatable object files consist of various code and data sections. Each section is a contiguous sequence of bytes. _Instructions_, _Initialized global variables_, _Uninitialized variables_ are in separate sections.

Linker's two main task:

- **Symbol resolution**: Object files define and reference _symbols_, where each symbol correspond to a function, a global variable, or a _static variable_. The purpose of symbol resolution is to associate each symbol _reference_ with exactly one symbole _definition_

- **Relocation**: Compilers and assemblers generate code and data sections that start at address 0. The linker _relocates_ these sections by associating a memory location with each symbol definition, and then modifying all of the references to those symbols so that they point to this memory location.

Basic fact: Object files are merely collections of blocks of bytes.

## Object files

Three forms of object files:

- Relocatable object file
- Excutable object file
- Shared object file

## Relocatable Object files

The _ELF header_ begins with a 16-byte sequence that describes the word size and byte ordering of the system that generate the file. The rest of the ELF header contains information that allows alinker to parse and interpret the object file

sections between ELF header and the section header:

- .text: the machine code of the compiled program
- .rodata: Read-only data such as the format strings in printf statemens and jump tables for switch statements
- .data: _Initialized_ global and static C variables.
- .bss: _Uninitialized_ global and static C variables, along with any global or static variables that are initialized to zero.
- .symtab: A _symbol table_ with information about functions and global variables that defined and referenced in the program.
- .rel.text: A list of locations in the .text section that will need to be modified when the linker combines this object file with others.
- .rel.data: Relocation information for any global variables that are referenced or defined by the module.
- .debug: A debugging symbol table with entries for local variables and typedefs defined in the program, global variables defined and referenced in the program, and the original C source file.
- .line: A mapping between line numbers in the original C source program and machine code instructions in the .text section.
- .strtab: A string table for the symbol tables in the .symtab and .debug sections and for the section names in the section headers.